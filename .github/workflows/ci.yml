name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  XCODE_VERSION: '26'  # Swift 6.2 - required for swift-tools-version 6.2
  # Note: DEVELOPER_DIR is set automatically by setup-xcode action

jobs:
  build:
    name: Build (Debug)
    runs-on: macos-26
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: System Info
        run: |
          echo "## System Info" >> $GITHUB_STEP_SUMMARY
          echo "- Swift: $(swift --version | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "- Xcode: $(xcodebuild -version | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "- macOS: $(sw_vers -productVersion)" >> $GITHUB_STEP_SUMMARY
          echo "- CPU: $(sysctl -n machdep.cpu.brand_string)" >> $GITHUB_STEP_SUMMARY

      - name: Cache SPM (commit-specific)
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
            ${{ runner.os }}-spm-

      - name: Resolve Dependencies
        run: swift package resolve

      - name: Build (Debug)
        run: |
          swift build -v 2>&1 | tee build.log
          echo "## Build (Debug)" >> $GITHUB_STEP_SUMMARY
          echo "Build succeeded" >> $GITHUB_STEP_SUMMARY

      - name: Upload Build Log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 7

  # ============================================================================
  # Test Jobs - Split into batches to avoid hanging and isolate failures
  # ============================================================================

  test-tokenizer:
    name: Test (Tokenizer)
    runs-on: macos-26
    needs: build
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Restore SPM Cache
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
            ${{ runner.os }}-spm-

      - name: Run Tokenizer Tests
        run: |
          echo "Running tokenizer tests..."
          swift test --filter "^EmbedKitTests\.(BPETokenizerTests|SentencePieceTokenizerTests|WordPieceTokenizerTests|TokenizerLoaderTests|TokenizerParityTests|TokenizerDeepTests|TokenizerContractionsHyphenNumeralsTests|TokenizerSubwordDecodeTests|TokenizerUnicodePunctuationTests|TokenizerUNKBehaviorTests|TokenCacheKeyTests|TokenCacheTests|TokenizationConcurrencyTests|TokenLengthSortingTests)" 2>&1 | tee test.log

          if grep -q "Test run with" test.log; then
            SUMMARY=$(grep "Test run with" test.log | tail -1)
            echo "## Tokenizer Tests" >> $GITHUB_STEP_SUMMARY
            echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Test Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-tokenizer-log
          path: test.log
          retention-days: 7

  test-batch:
    name: Test (Batch Processing)
    runs-on: macos-26
    needs: build
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Restore SPM Cache
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
            ${{ runner.os }}-spm-

      - name: Run Batch Tests
        run: |
          echo "Running batch processing tests..."
          swift test --filter "^EmbedKitTests\.(BatchOrderAndMaskTests|BatchPaddingTests|BatchPerformanceTests|BatchProgressTests|BatchTokenizationTests|BatchTruncationParityTests|BatchTruncationStrategyTests|AdaptiveBatcherTests|AdvancedBatchingConstraintsTests|MicroBatchConstraintsTests|MicroBatchingMaxTokensTests|PipelinedBatchProcessorTests|TripleBufferingTests)" 2>&1 | tee test.log

          if grep -q "Test run with" test.log; then
            SUMMARY=$(grep "Test run with" test.log | tail -1)
            echo "## Batch Tests" >> $GITHUB_STEP_SUMMARY
            echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Test Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-batch-log
          path: test.log
          retention-days: 7

  test-metal:
    name: Test (Metal/GPU)
    runs-on: macos-26
    needs: build
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Restore SPM Cache
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
            ${{ runner.os }}-spm-

      - name: Run Metal Tests
        run: |
          echo "Running Metal/GPU tests..."
          swift test --filter "^EmbedKitTests\.(MetalLoaderTests|MetalNormalizationParityTests|MetalPoolingParityTests|MetalSimilarityParityTests|MetalContextIntegrationTests|Metal4CommandEncodingTests|Metal4EdgeCaseTests|Metal4ResourceManagementTests|SharedMetalContextManagerTests|GPUOptimizerTests|GPUOptimizerPersistenceTests|AccelerateBLASTests|AccelerationManagerTests|TensorOperationsTests|TensorStorageManagerTests|TensorLifecycleManagerTests|TensorOperationDispatcherTests)" 2>&1 | tee test.log

          if grep -q "Test run with" test.log; then
            SUMMARY=$(grep "Test run with" test.log | tail -1)
            echo "## Metal Tests" >> $GITHUB_STEP_SUMMARY
            echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Test Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-metal-log
          path: test.log
          retention-days: 7

  test-embedding:
    name: Test (Embedding Core)
    runs-on: macos-26
    needs: build
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Restore SPM Cache
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
            ${{ runner.os }}-spm-

      - name: Run Embedding Core Tests
        run: |
          echo "Running embedding core tests..."
          swift test --filter "^EmbedKitTests\.(EmbeddingGeneratorTests|EmbeddingStoreTests|EmbeddingStoreAccelerationTests|EmbeddingStoreConcurrencyTests|EmbeddingStoreExtensionsTests|EmbeddingStoreIndexTypeTests|EmbeddingStorePersistenceTests|PoolingStrategyTests|AttentionPoolingTests|NumericalStabilityTests|QuantizationTests|ShapeInferenceTests)" 2>&1 | tee test.log

          if grep -q "Test run with" test.log; then
            SUMMARY=$(grep "Test run with" test.log | tail -1)
            echo "## Embedding Core Tests" >> $GITHUB_STEP_SUMMARY
            echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Test Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-embedding-log
          path: test.log
          retention-days: 7

  test-config:
    name: Test (Configuration)
    runs-on: macos-26
    needs: build
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Restore SPM Cache
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
            ${{ runner.os }}-spm-

      - name: Run Configuration Tests
        run: |
          echo "Running configuration tests..."
          swift test --filter "^EmbedKitTests\.(ConfigurationFactoryTests|ConfigurationMatrixTests|ConvenienceAPITests|AutoDevicePolicyTests|DimensionValidationTests|OutputSelectionTests|PaddingInvariantsTests|PaddingPositiveTests|PadStrictnessTests|TruncationFlagTests|WarmupIdempotencyTests)" 2>&1 | tee test.log

          if grep -q "Test run with" test.log; then
            SUMMARY=$(grep "Test run with" test.log | tail -1)
            echo "## Configuration Tests" >> $GITHUB_STEP_SUMMARY
            echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Test Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-config-log
          path: test.log
          retention-days: 7

  test-coreml:
    name: Test (CoreML)
    runs-on: macos-26
    needs: build
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Restore SPM Cache
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
            ${{ runner.os }}-spm-

      - name: Run CoreML Tests
        run: |
          echo "Running CoreML tests..."
          swift test --filter "^EmbedKitTests\.(CoreMLBackendTests|CoreMLInputValidationTests|CoreMLOverridesTests|LocalCoreMLModelTests|OnDeviceCoreMLTests|AppleEmbeddingModelTests|ModelDiscoveryTests|ModelManagerBatchIntegrationTests)" 2>&1 | tee test.log || true

          if grep -q "Test run with" test.log; then
            SUMMARY=$(grep "Test run with" test.log | tail -1)
            echo "## CoreML Tests" >> $GITHUB_STEP_SUMMARY
            echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY
          else
            echo "## CoreML Tests" >> $GITHUB_STEP_SUMMARY
            echo "Tests may have been skipped (no model available)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Test Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-coreml-log
          path: test.log
          retention-days: 7

  test-streaming:
    name: Test (Streaming & Cache)
    runs-on: macos-26
    needs: build
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Restore SPM Cache
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
            ${{ runner.os }}-spm-

      - name: Run Streaming & Cache Tests
        run: |
          echo "Running streaming & cache tests..."
          swift test --filter "^EmbedKitTests\.(StreamingTests|StreamingProcessorTests|PersistentCacheTests|CacheHitRateProgressionTests|ConcurrencyCacheTests|MemoryPressureHandlingTests|MemoryTrimTests|MemoryAwareGeneratorTests)" 2>&1 | tee test.log

          if grep -q "Test run with" test.log; then
            SUMMARY=$(grep "Test run with" test.log | tail -1)
            echo "## Streaming & Cache Tests" >> $GITHUB_STEP_SUMMARY
            echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Test Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-streaming-log
          path: test.log
          retention-days: 7

  test-error-recovery:
    name: Test (Error & Metrics)
    runs-on: macos-26
    needs: build
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Restore SPM Cache
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
            ${{ runner.os }}-spm-

      - name: Run Error & Metrics Tests
        run: |
          echo "Running error & metrics tests..."
          swift test --filter "^EmbedKitTests\.(ErrorRecoveryTests|VSKErrorConformanceTests|StageMetricsTests|StageMetricsAveragesTests|StageMetricsBatchSizeTests|StageMetricsResetTests|HistogramMetricsTests|RequestPrioritizationTests|CancellableEmbeddingTaskTests|MeanPoolingFallbackTests)" 2>&1 | tee test.log

          if grep -q "Test run with" test.log; then
            SUMMARY=$(grep "Test run with" test.log | tail -1)
            echo "## Error & Metrics Tests" >> $GITHUB_STEP_SUMMARY
            echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Test Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-error-log
          path: test.log
          retention-days: 7

  test-integration:
    name: Test (Integration)
    runs-on: macos-26
    needs: build
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Restore SPM Cache
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
            ${{ runner.os }}-spm-

      - name: Run Integration Tests
        run: |
          echo "Running integration tests..."
          swift test --filter "^EmbedKitTests\.(ComprehensiveTests|CrossPackageIntegrationTests|VSKIntegrationTests|Week1IntegrationTests|V020IntegrationTests|EndToEndPipelineTests)" 2>&1 | tee test.log

          if grep -q "Test run with" test.log; then
            SUMMARY=$(grep "Test run with" test.log | tail -1)
            echo "## Integration Tests" >> $GITHUB_STEP_SUMMARY
            echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Test Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-integration-log
          path: test.log
          retention-days: 7

  # Note: Stress tests are separated due to known hanging issues with Swift Testing
  # These run with a longer timeout and failure doesn't block the overall CI
  test-stress:
    name: Test (Stress - Non-blocking)
    runs-on: macos-26
    needs: build
    timeout-minutes: 30
    continue-on-error: true  # Don't block CI if these hang

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Restore SPM Cache
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
            ${{ runner.os }}-spm-

      - name: Run Stress Tests (with timeout)
        run: |
          echo "Running stress tests (may be skipped if they hang)..."
          echo "## Stress Tests" >> $GITHUB_STEP_SUMMARY

          # Run with timeout to prevent hanging
          timeout 1200 swift test --filter "^EmbedKitTests\.(Batch6StressTests|Batch6EdgeCaseTests|ConcurrencyStressTests)" 2>&1 | tee test.log || {
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 124 ]; then
              echo "Stress tests timed out (known issue with Swift Testing)" >> $GITHUB_STEP_SUMMARY
            fi
          }

          if grep -q "Test run with" test.log; then
            SUMMARY=$(grep "Test run with" test.log | tail -1)
            echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Test Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-stress-log
          path: test.log
          retention-days: 7

  test-benchmarks:
    name: Test (Benchmarks - Non-blocking)
    runs-on: macos-26
    needs: build
    timeout-minutes: 20
    continue-on-error: true  # Benchmarks are informational

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Restore SPM Cache
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
            ${{ runner.os }}-spm-

      - name: Run Benchmark Tests
        run: |
          echo "Running benchmark tests..."
          timeout 900 swift test --filter "^EmbedKitTests\.(Batch6PerformanceBenchmarks|FinalBenchmarksTests)" 2>&1 | tee test.log || true

          if grep -q "Test run with" test.log; then
            SUMMARY=$(grep "Test run with" test.log | tail -1)
            echo "## Benchmark Tests" >> $GITHUB_STEP_SUMMARY
            echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Test Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-benchmarks-log
          path: test.log
          retention-days: 7

  # ============================================================================
  # Build Release
  # ============================================================================

  build-release:
    name: Build (Release)
    runs-on: macos-26
    needs: build
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.XCODE_VERSION }}

      - name: Restore SPM Cache
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
            ${{ runner.os }}-spm-

      - name: Build (Release)
        run: |
          swift build -c release -v 2>&1 | tee build-release.log
          echo "## Build (Release)" >> $GITHUB_STEP_SUMMARY
          echo "Release build succeeded" >> $GITHUB_STEP_SUMMARY

      - name: Upload Build Log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-release-log
          path: build-release.log
          retention-days: 7

  # ============================================================================
  # Lint
  # ============================================================================

  lint:
    name: SwiftLint
    runs-on: macos-26
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: |
          echo "Running SwiftLint $(swiftlint version)"

          # Run SwiftLint and capture output
          swiftlint lint --reporter github-actions-logging 2>&1 | tee swiftlint.log || true

          # Count issues
          WARNINGS=$(grep -c "warning:" swiftlint.log 2>/dev/null || echo "0")
          ERRORS=$(grep -c "error:" swiftlint.log 2>/dev/null || echo "0")

          echo "## SwiftLint Results" >> $GITHUB_STEP_SUMMARY
          echo "- Warnings: $WARNINGS" >> $GITHUB_STEP_SUMMARY
          echo "- Errors: $ERRORS" >> $GITHUB_STEP_SUMMARY

          # Only fail on errors, warnings are acceptable
          if [ "$ERRORS" -gt 0 ]; then
            echo "SwiftLint found $ERRORS error(s)" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "No SwiftLint errors" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload SwiftLint Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: swiftlint-log
          path: swiftlint.log
          retention-days: 7
